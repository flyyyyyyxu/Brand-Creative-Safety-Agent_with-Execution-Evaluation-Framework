#!/usr/bin/env python3
import json
import uuid
import argparse
from datetime import datetime, timezone
from pathlib import Path

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--task_id", required=True)
    parser.add_argument("--strategy_id", required=True)
    parser.add_argument("--timeout", type=int, default=90)
    parser.add_argument("--max_steps", type=int, default=8)
    args = parser.parse_args()

    # 读取任务配置
    with open("datasets/tasks.json") as f:
        config = json.load(f)
    
    task = next((t for t in config["tasks"] if t["task_id"] == args.task_id), None)
    if not task:
        print(f"[ERROR] Task {args.task_id} not found")
        return

    print(f"[INFO] Starting run: task={args.task_id}, strategy={args.strategy_id}")

    # 构造输出记录（v0：假数据，success=false，等待接入 OpenClaw）
    run_record = {
        "run_id": str(uuid.uuid4()),
        "timestamp_utc": datetime.now(timezone.utc).isoformat(),
        "brand": config["brand"],
        "task_id": args.task_id,
        "strategy_id": args.strategy_id,
        "query": task["query"],
        "success": False,
        "failure_type": "not_implemented",
        "step_count": 0,
        "latency_ms": 0,
        "token_cost_estimate": 0,
        "sources": [],
        "analysis": {
            "summary": "",
            "sentiment": {"label": "neutral", "score": 0.0},
            "risk_keywords": [],
            "relevance_score": 0.0
        },
        "risk": {
            "negative_ratio": 0.0,
            "keyword_weight": 0.0,
            "recentness_factor": 0.0,
            "risk_score": 0.0,
            "risk_level": "low"
        },
        "debug": {"notes": "v0 skeleton - not implemented", "screenshot_path": None, "trace_path": None}
    }

    # 写入 artifacts/runs.jsonl
    Path("artifacts").mkdir(exist_ok=True)
    with open("artifacts/runs.jsonl", "a") as f:
        f.write(json.dumps(run_record, ensure_ascii=False) + "\n")

    print(f"[INFO] Writing to artifacts/runs.jsonl")
    print(f"[INFO] Run completed: success=false, failure_type=not_implemented")

if __name__ == "__main__":
    main()